title: "Has JACK zero latency?"
authors: Daniel Schürmann
tags: 2.3, jack, alsa, sound, latency, pipewire
date: 2021.03.18 02:42:18

In regular intervals, we discuss how much latency the [JACK Audio Connection Kit](https://jackaudio.org) introduces when used in Mixxx. That is one of the [Sound APIs](https://manual.mixxx.org/2.3/en/chapters/preferences.html#sound-api) that Mixxx supports on Linux, and it's a layer on top of the [Advances Linux Sound Architecture (ALSA)](https://www.alsa-project.org). The [JACK FAQ](https://jackaudio.org/faq/no_extra_latency.html) state that:
> There is **NO** extra latency caused by using JACK for audio input and output. When we say none, we mean absolutely zero.

This is true on its own, because JACK uses directly the buffer configured for ALSA to mix the audio sources together. ALSA has a second buffer with the same length that is used to feed these samples into the hardware. That's all.

However, in the case of Mixxx another buffer is used, because Mixxx has its own real-time mixing stage and uses the [PortAudio](http://www.portaudio.com) abstraction layer. In addition, most distros use JACK with it's default "Server Asynchronous Mode" which introduce one buffer extra latency (--async-latency);

When using the ALSA API directly Mixxx does what JACK does. It uses the ALSA buffer directly, which doesn't add any latency.

This can be confirmed by recording the own sound via a mic and measure the round trip latency. For my test, I have used the internal speaker, microphone and ALC298 Analog sound. For separating the signals in one stereo stream, I have enabled the Balance effect for deck 1 fully right and for mic fully left. The test track is a 440 Hz sine wave generated by [Audacity](https://www.audacityteam.org). Then I have cued the track into the pre-roll start recording and press play.

Here the resulting recordings visualized in [Audacity](https://www.audacityteam.org):

![Screenshot of audacity showing the round trip latency]({static}/images/news/roundtriplatency.png)


The upper stream is the JACK case. The left channel is the recorded master 440 Hz sine wave and the right channel is the mic input.

JACK is configured with a 1024 frames buffer and reports a latency of 46.4 ms for the sum of two buffers .
The round trip latency is 95 ms ~4 buffers = Driver + ALSA + JACK Async mode + (PortAudio)

The lower stream is the ALSA case. Mixxx is configures with the same single buffer of 1024 frames = 23.2 ms
The round trip latency is 49 ms ~2 buffers = Driver + ALSA

Not in the picture is the ALSA pulse device. It runs at a latency of 104 ms ~5 buffers. Driver + ALSA + 2 x Pulse + ALSA
PipeWire on Fedora 34 has by default the same latency like JACK in this test.

With this picture we can verify that Mixxx actually has the same buffer size in both cases. When pressing pause, it fades the signal out over one buffer length which is equal in both cases.
The peaks in the recorded right channel is the sound of the mouse click. You can only barely see the recorded sine wave.

![Screenshot of audacity showing the fade out]({static}/images/news/fadeoutcompare.png)

For reference, I have done the same test using [jack_iodelay](http://manpages.ubuntu.com/manpages/bionic/man1/jack_iodelay.1.html)

```
  3114.842 frames     70.631 ms total roundtrip latency
	extra loopback latency: 42 frames
	use 21 for the backend arguments -I and -O Inv
```

The result is 70 ms ~3 buffers = Driver + ALSA + JACK Async mode. This is one buffer more than a native ALSA implementation.

From Ubuntu Hirsute 21.4, QJackCtl exposes a "Use server synchronous mode" checkbox in the sound card preferences. It is grayed out by default but becomes active if "Enable JACK D-Bus interface" is checked as well. In this case the JACK mixing is done after Mixxx in the same time interval.

## Conclusion

For now, we recommend using Mixxx with the ALSA backends even if you are running JACK. The same applies to [PipeWire](https://pipewire.org) as Mixxx uses JACK protocol to connect to it.

It should be also noted that JACK can't deal (well) with two or more sound cards. Mixxx can do this using the ALSA API and this with no extra latency as long the underlying driver allows it.

## What comes next?

There is a chance to get rid of the extra latency and make Mixxx use the buffer provided by Jack/PipeWire. This requires that Mixxx becomes a native Jack or Pipewire application by using their client libraries directly or via a thin wrapper library.

A lot to do. Do you have interest to help? Get in contact with us at [Zulip](https://mixxx.zulipchat.com)
